#!/bin/sh

noOperation(){
	echo "Usage: $0 [operations] [options] [input_file]"
	echo "Type \"$0 --help\" for more"
}

help(){
	echo "I'll do the documentaion later lol"
}

if [ $# -eq 0 ] ; then noOperation "$@"
elif [ "$(echo "$*" | sed "s/ /\\n/g" | grep \\--help)" = "--help" ] ; then help "$@" ; exit
else
	#Checking for adequate dependencies
	if ! command -v gpg > /dev/null 2>&1 ; then echo "gnupg is not installed"; exit 127; fi
	
	cleanUp(){
		rm "$tmpFile"
	}

	showText(){
		[ "$success" -eq 0 ] && \
		echo && head -n 1 "$tmpFile" && echo && echo
	}

	clearClipboard(){
		[ "$success" -eq 0 ] && [ -n "$clipboard" ] && \
		echo "Clearing the clipboard in 15 seconds" && \
		sleep 15 && $clipboard < /dev/null &
	}

	decryption(){
		tmpFile=$(mktemp -u)
		for lastArg in "$@"; do :; done
		if [ ! -f "$lastArg" ]; then echo "There is no input file"; exit 1; fi
		gpg --no-symkey-cache --output "$tmpFile" "$lastArg" ; success=$?

		# Clipboards by OS'
		[ -n "$WAYLAND_DISPLAY" ] && command -v wl-copy > /dev/null 2>&1 && clipboard="wl-copy" || \
		command -v xclip > /dev/null 2>&1 && clipboard="xclip -selection clip"
		command -v pbcopy > /dev/null 2>&1 && clipboard="pbcopy"
		[ -d "/c/Windows" ] && command -v clip.exe > /dev/null 2>&1 && clipboard="clip.exe"

		[ "$success" -eq 0 ] && [ -n "$clipboard" ] && \
		head -n 1 "$tmpFile" | $clipboard &&\
		echo Copied to clipboard sucessfully 

		# If the script doesn't detect any clipboard programs
		[ "$success" -eq 0 ] && [ -z "$clipboard" ] && \
		echo "Could not find any clipboards" && \
		[ -z "$showTextOption" ] && cleanUp "$@" && exit 127
		$clearClipOption
		$showTextOption
	}
	numOfOperations=0
	OPTIND=1
	while getopts ":hEDcsg:" OPTION; do
		case $OPTION in
			h) help "$@" ; exit ;;
			D) numOfOperations=$((numOfOperations+1)) ; operation=decrypt ;;
			E) numOfOperations=$((numOfOperations+1)) ; operation=encrypt ;;
			c) clearClipOption='clearClipboard "$@"' ;;
			s) showTextOption='showText "$@"' ;;
			*) echo "-$OPTARG is a unknown option" && exit 1 ;;
		esac
	done

	[ $numOfOperations -gt 1 ] && echo "-E and -D options shouldn't be used together " && exit 1

	case "$operation" in
		decrypt) decryption "$@" ;;
		encrypt) echo "Work in Progress" ;;
		*) echo "No operation was specified" ; noOperation "$@" ;;
	esac
	
	[ -n "$success" ] && [ $success -eq 0 ] && cleanUp "$@"
fi	
